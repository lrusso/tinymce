!function(){"use strict";var e,t=tinymce.util.Tools.resolve("tinymce.PluginManager"),n={hasDimensions:function(e){return!1!==e.settings.image_dimensions},hasAdvTab:function(e){return!0===e.settings.image_advtab},getPrependUrl:function(e){return e.getParam("image_prepend_url","")},getClassList:function(e){return e.getParam("image_class_list")},hasDescription:function(e){return!1!==e.settings.image_description},hasImageTitle:function(e){return!0===e.settings.image_title},hasImageCaption:function(e){return!0===e.settings.image_caption},getImageList:function(e){return e.getParam("image_list",!1)},hasUploadUrl:function(e){return e.getParam("images_upload_url",!1)},hasUploadHandler:function(e){return e.getParam("images_upload_handler",!1)},getUploadUrl:function(e){return e.getParam("images_upload_url")},getUploadHandler:function(e){return e.getParam("images_upload_handler")},getUploadBasePath:function(e){return e.getParam("images_upload_base_path")},getUploadCredentials:function(e){return e.getParam("images_upload_credentials")}},a="undefined"!=typeof window?window:Function("return this;")(),r=function(e,t){return function(e,t){for(var n=null!=t?t:a,r=0;r<e.length&&null!=n;++r)n=n[e[r]];return n}(e.split("."),t)},i={getOrDie:function(e,t){var n=function(e,t){return r(e,t)}(e,t);if(null==n)throw e+" not available on this browser";return n}},o=tinymce.util.Tools.resolve("tinymce.util.Promise"),l=tinymce.util.Tools.resolve("tinymce.util.Tools"),u=tinymce.util.Tools.resolve("tinymce.util.XHR"),s=function(e,t){return Math.max(parseInt(e,10),parseInt(t,10))},c={getImageSize:function(e,t){var n=document.createElement("img");function a(e,a){n.parentNode&&n.parentNode.removeChild(n),t({width:e,height:a})}n.onload=function(){a(s(n.width,n.clientWidth),s(n.height,n.clientHeight))},n.onerror=function(){a(0,0)};var r=n.style;r.visibility="hidden",r.position="fixed",r.bottom=r.left="0px",r.width=r.height="auto",document.body.appendChild(n),n.src=e},buildListItems:function(e,t,n){return function e(n,a){return a=a||[],l.each(n,function(n){var r={text:n.text||n.title};n.menu?r.menu=e(n.menu):(r.value=n.value,t(r)),a.push(r)}),a}(e,n||[])},removePixelSuffix:function(e){return e&&(e=e.replace(/px$/,"")),e},addPixelSuffix:function(e){return e.length>0&&/^[0-9]+$/.test(e)&&(e+="px"),e},mergeMargins:function(e){if(e.margin){var t=e.margin.split(" ");switch(t.length){case 1:e["margin-top"]=e["margin-top"]||t[0],e["margin-right"]=e["margin-right"]||t[0],e["margin-bottom"]=e["margin-bottom"]||t[0],e["margin-left"]=e["margin-left"]||t[0];break;case 2:e["margin-top"]=e["margin-top"]||t[0],e["margin-right"]=e["margin-right"]||t[1],e["margin-bottom"]=e["margin-bottom"]||t[0],e["margin-left"]=e["margin-left"]||t[1];break;case 3:e["margin-top"]=e["margin-top"]||t[0],e["margin-right"]=e["margin-right"]||t[1],e["margin-bottom"]=e["margin-bottom"]||t[2],e["margin-left"]=e["margin-left"]||t[1];break;case 4:e["margin-top"]=e["margin-top"]||t[0],e["margin-right"]=e["margin-right"]||t[1],e["margin-bottom"]=e["margin-bottom"]||t[2],e["margin-left"]=e["margin-left"]||t[3]}delete e.margin}return e},createImageList:function(e,t){var a=n.getImageList(e);"string"==typeof a?u.send({url:a,success:function(e){t(JSON.parse(e))}}):"function"==typeof a?a(t):t(a)},waitLoadImage:function(e,t,a){function r(){a.onload=a.onerror=null,e.selection&&(e.selection.select(a),e.nodeChanged())}a.onload=function(){t.width||t.height||!n.hasDimensions(e)||e.dom.setAttribs(a,{width:a.clientWidth,height:a.clientHeight}),r()},a.onerror=r},blobToDataUri:function(e){return new o(function(t,n){var a=new(i.getOrDie("FileReader"));a.onload=function(){t(a.result)},a.onerror=function(){n(a.error.message)},a.readAsDataURL(e)})}},d=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),g=Object.prototype.hasOwnProperty,m=(e=function(e,t){return t},function(){for(var t=new Array(arguments.length),n=0;n<t.length;n++)t[n]=arguments[n];if(0===t.length)throw new Error("Can't merge zero objects");for(var a={},r=0;r<t.length;r++){var i=t[r];for(var o in i)g.call(i,o)&&(a[o]=e(a[o],i[o]))}return a}),f=d.DOM,p=function(e){return e.style.marginLeft&&e.style.marginRight&&e.style.marginLeft===e.style.marginRight?c.removePixelSuffix(e.style.marginLeft):""},h=function(e){return e.style.marginTop&&e.style.marginBottom&&e.style.marginTop===e.style.marginBottom?c.removePixelSuffix(e.style.marginTop):""},v=function(e){return e.style.borderWidth?c.removePixelSuffix(e.style.borderWidth):""},b=function(e,t){return e.hasAttribute(t)?e.getAttribute(t):""},y=function(e,t){return e.style[t]?e.style[t]:""},x=function(e){return null!==e.parentNode&&"FIGURE"===e.parentNode.nodeName},w=function(e,t,n){e.setAttribute(t,n)},S=function(e){x(e)?function(e){var t=e.parentNode;f.insertAfter(e,t),f.remove(t)}(e):function(e){var t=f.create("figure",{class:"image"});f.insertAfter(t,e),t.appendChild(e),t.appendChild(f.create("figcaption",{contentEditable:!0},"Caption")),t.contentEditable="false"}(e)},U=function(e,t){var n=e.getAttribute("style"),a=t(null!==n?n:"");a.length>0?(e.setAttribute("style",a),e.setAttribute("data-mce-style",a)):e.removeAttribute("style")},C=function(e,t){return function(e,n,a){e.style[n]?(e.style[n]=c.addPixelSuffix(a),U(e,t)):w(e,n,a)}},T=function(e,t){return e.style[t]?c.removePixelSuffix(e.style[t]):b(e,t)},I=function(e,t){var n=c.addPixelSuffix(t);e.style.marginLeft=n,e.style.marginRight=n},P=function(e,t){var n=c.addPixelSuffix(t);e.style.marginTop=n,e.style.marginBottom=n},L=function(e,t){var n=c.addPixelSuffix(t);e.style.borderWidth=n},N=function(e,t){e.style.borderStyle=t},A=function(e){return"FIGURE"===e.nodeName},_=function(e,t){var n=document.createElement("img");return w(n,"style",t.style),(p(n)||""!==t.hspace)&&I(n,t.hspace),(h(n)||""!==t.vspace)&&P(n,t.vspace),(v(n)||""!==t.border)&&L(n,t.border),(function(e){return y(e,"borderStyle")}(n)||""!==t.borderStyle)&&N(n,t.borderStyle),e(n.getAttribute("style"))},R=function(e,t){return{src:b(t,"src"),alt:b(t,"alt"),title:b(t,"title"),width:T(t,"width"),height:T(t,"height"),class:b(t,"class"),style:e(b(t,"style")),caption:x(t),hspace:p(t),vspace:h(t),border:v(t),borderStyle:y(t,"borderStyle")}},D=function(e,t,n,a,r){n[a]!==t[a]&&r(e,a,n[a])},k=function(e,t){return function(n,a,r){e(n,r),U(n,t)}},O=function(e,t,n){var a=R(e,n);D(n,a,t,"caption",function(e,t,n){return S(e)}),D(n,a,t,"src",w),D(n,a,t,"alt",w),D(n,a,t,"title",w),D(n,a,t,"width",C(0,e)),D(n,a,t,"height",C(0,e)),D(n,a,t,"class",w),D(n,a,t,"style",k(function(e,t){return w(e,"style",t)},e)),D(n,a,t,"hspace",k(I,e)),D(n,a,t,"vspace",k(P,e)),D(n,a,t,"border",k(L,e)),D(n,a,t,"borderStyle",k(N,e))},z=function(e,t){var n=e.dom.styles.parse(t),a=c.mergeMargins(n),r=e.dom.styles.parse(e.dom.styles.serialize(a));return e.dom.styles.serialize(r)},M=function(e){var t=e.selection.getNode(),n=e.dom.getParent(t,"figure.image");return n?e.dom.select("img",n)[0]:t&&("IMG"!==t.nodeName||t.getAttribute("data-mce-object")||t.getAttribute("data-mce-placeholder"))?null:t},E=function(e,t){var n=e.dom,a=n.getParent(t.parentNode,function(t){return e.schema.getTextBlockElements()[t.nodeName]},e.getBody());return a?n.split(a,t):t},H=function(e){var t=M(e);return t?R(function(t){return z(e,t)},t):{src:"",alt:"",title:"",width:"",height:"",class:"",style:"",caption:!1,hspace:"",vspace:"",border:"",borderStyle:""}},B=function(e,t){var n=function(e,t){var n=document.createElement("img");if(O(e,m(t,{caption:!1}),n),w(n,"alt",t.alt),t.caption){var a=f.create("figure",{class:"image"});return a.appendChild(n),a.appendChild(f.create("figcaption",{contentEditable:!0},"Caption")),a.contentEditable="false",a}return n}(function(t){return z(e,t)},t);e.dom.setAttrib(n,"data-mce-id","__mcenew"),e.focus(),e.selection.setContent(n.outerHTML);var a=e.dom.select('*[data-mce-id="__mcenew"]')[0];if(e.dom.setAttrib(a,"data-mce-id",null),A(a)){var r=E(e,a);e.selection.select(r)}else e.selection.select(a)},j=function(e,t){var n=M(e);n?t.src?function(e,t){var n=M(e);if(O(function(t){return z(e,t)},t,n),function(e,t){e.dom.setAttrib(t,"src",t.getAttribute("src"))}(e,n),A(n.parentNode)){var a=n.parentNode;E(e,a),e.selection.select(n.parentNode)}else e.selection.select(n),c.waitLoadImage(e,t,n)}(e,t):function(e,t){if(t){var n=e.dom.is(t.parentNode,"figure.image")?t.parentNode:t;e.dom.remove(n),e.focus(),e.nodeChanged(),e.dom.isEmpty(e.getBody())&&(e.setContent(""),e.selection.setCursorLocation())}}(e,n):t.src&&B(e,t)},F=function(e){return function(t){var a=e.dom,r=t.control.rootControl;if(n.hasAdvTab(e)){var i=r.toJSON(),o=a.parseStyle(i.style);r.find("#vspace").value(""),r.find("#hspace").value(""),((o=c.mergeMargins(o))["margin-top"]&&o["margin-bottom"]||o["margin-right"]&&o["margin-left"])&&(o["margin-top"]===o["margin-bottom"]?r.find("#vspace").value(c.removePixelSuffix(o["margin-top"])):r.find("#vspace").value(""),o["margin-right"]===o["margin-left"]?r.find("#hspace").value(c.removePixelSuffix(o["margin-right"])):r.find("#hspace").value("")),o["border-width"]?r.find("#border").value(c.removePixelSuffix(o["border-width"])):r.find("#border").value(""),o["border-style"]?r.find("#borderStyle").value(o["border-style"]):r.find("#borderStyle").value(""),r.find("#style").value(a.serializeStyle(a.parseStyle(a.serializeStyle(o))))}}},W=function(e,t){t.find("#style").each(function(n){var a=_(function(t){return z(e,t)},m({src:"",alt:"",title:"",width:"",height:"",class:"",style:"",caption:!1,hspace:"",vspace:"",border:"",borderStyle:""},t.toJSON()));n.value(a)})},G={makeTab:function(e){return{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:F(e)},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,defaults:{type:"textbox",maxWidth:50,onchange:function(t){W(e,t.control.rootControl)}},items:[{label:"Vertical space",name:"vspace"},{label:"Border width",name:"border"},{label:"Horizontal space",name:"hspace"},{label:"Border style",type:"listbox",name:"borderStyle",width:120,maxWidth:120,onselect:function(t){W(e,t.control.rootControl)},values:[{text:"Select...",value:""},{text:"Solid",value:"solid"},{text:"Dotted",value:"dotted"},{text:"Dashed",value:"dashed"},{text:"Double",value:"double"},{text:"Groove",value:"groove"},{text:"Ridge",value:"ridge"},{text:"Inset",value:"inset"},{text:"Outset",value:"outset"},{text:"None",value:"none"},{text:"Hidden",value:"hidden"}]}]}]}}},J=function(e,t){e.state.set("oldVal",e.value()),t.state.set("oldVal",t.value())},V=function(e,t){var n=e.find("#width")[0],a=e.find("#height")[0],r=e.find("#constrain")[0];n&&a&&r&&t(n,a,r.checked())},$=function(e,t,n){var a=e.state.get("oldVal"),r=t.state.get("oldVal"),i=e.value(),o=t.value();n&&a&&r&&i&&o&&(i!==a?(o=Math.round(i/a*o),isNaN(o)||t.value(o)):(i=Math.round(o/r*i),isNaN(i)||e.value(i))),J(e,t)},X=function(e){V(e,$)},q={createUi:function(){var e=function(e){X(e.control.rootControl)};return{type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:5,onchange:e,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:5,onchange:e,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}},syncSize:function(e){V(e,J)},updateSize:X},K=function(e){e.meta=e.control.rootControl.toJSON()},Q=function(e,t){var a=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:function(t){!function(e,t){var a,r,i,o=e.meta||{},u=e.control,s=u.rootControl,d=s.find("#image-list")[0];d&&d.value(t.convertURL(u.value(),"src")),l.each(o,function(e,t){s.find("#"+t).value(e)}),o.width||o.height||(a=t.convertURL(u.value(),"src"),r=n.getPrependUrl(t),i=new RegExp("^(?:[a-z]+:)?//","i"),r&&!i.test(a)&&a.substring(0,r.length)!==r&&(a=r+a),u.value(a),c.getImageSize(t.documentBaseURI.toAbsolute(u.value()),function(e){e.width&&e.height&&n.hasDimensions(t)&&(s.find("#width").value(e.width),s.find("#height").value(e.height),q.syncSize(s))}))}(t,e)},onbeforecall:K},t];return n.hasDescription(e)&&a.push({name:"alt",type:"textbox",label:"Image description"}),n.hasImageTitle(e)&&a.push({name:"title",type:"textbox",label:"Image Title"}),n.hasDimensions(e)&&a.push(q.createUi()),n.getClassList(e)&&a.push({name:"class",type:"listbox",label:"Class",values:c.buildListItems(n.getClassList(e),function(t){t.value&&(t.textStyle=function(){return e.formatter.getCssText({inline:"img",classes:[t.value]})})})}),n.hasImageCaption(e)&&a.push({name:"caption",type:"checkbox",label:"Caption"}),a},Y={makeTab:function(e,t){return{title:"General",type:"form",items:Q(e,t)}},getGeneralItems:Q},Z=function(){return i.getOrDie("URL")},ee=function(e){return Z().createObjectURL(e)},te=function(e){Z().revokeObjectURL(e)},ne=tinymce.util.Tools.resolve("tinymce.ui.Factory"),ae=function(){},re=function(e,t){return e?e.replace(/\/$/,"")+"/"+t.replace(/^\//,""):t};function ie(e){var t=function(t,n,a,r){var o,l;(o=new(i.getOrDie("XMLHttpRequest"))).open("POST",e.url),o.withCredentials=e.credentials,o.upload.onprogress=function(e){r(e.loaded/e.total*100)},o.onerror=function(){a("Image upload failed due to a XHR Transport error. Code: "+o.status)},o.onload=function(){var t;o.status<200||o.status>=300?a("HTTP Error: "+o.status):(t=JSON.parse(o.responseText))&&"string"==typeof t.location?n(re(e.basePath,t.location)):a("Invalid JSON: "+o.responseText)},(l=new FormData).append("file",t.blob(),t.filename()),o.send(l)};return e=l.extend({credentials:!1,handler:t},e),{upload:function(n){return e.url||e.handler!==t?function(e,t){return new o(function(n,a){try{t(e,n,a,ae)}catch(e){a(e.message)}})}(n,e.handler):o.reject("Upload url missing from the settings.")}}}var oe=function(e){return function(t){var a=ne.get("Throbber"),r=t.control.rootControl,i=new a(r.getEl()),o=t.control.value(),l=ee(o),u=ie({url:n.getUploadUrl(e),basePath:n.getUploadBasePath(e),credentials:n.getUploadCredentials(e),handler:n.getUploadHandler(e)}),s=function(){i.hide(),te(l)};return i.show(),c.blobToDataUri(o).then(function(t){var n=e.editorUpload.blobCache.create({blob:o,blobUri:l,name:o.name?o.name.replace(/\.[^\.]+$/,""):null,base64:t.split(",")[1]});return u.upload(n).then(function(e){var t=r.find("#src");return t.value(e),r.find("tabpanel")[0].activateTab(0),t.fire("change"),s(),e})}).catch(function(t){e.windowManager.alert(t),s()})}},le={makeTab:function(e){return{title:"Upload",type:"form",layout:"flex",direction:"column",align:"stretch",padding:"20 20 20 20",items:[{type:"container",layout:"flex",direction:"column",align:"center",spacing:10,items:[{text:"Browse for an image",type:"browsebutton",accept:".jpg,.jpeg,.png,.gif",onchange:oe(e)},{text:"OR",type:"label"}]},{text:"Drop an image here",type:"dropzone",accept:".jpg,.jpeg,.png,.gif",height:100,onchange:oe(e)}]}}};function ue(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return function(){for(var n=[],a=0;a<arguments.length;a++)n[a]=arguments[a];var r=t.concat(n);return e.apply(null,r)}}var se=function(e,t){var n=t.control.getRoot();q.updateSize(n),e.undoManager.transact(function(){var t=m(H(e),n.toJSON());j(e,t)}),e.editorUpload.uploadImagesAuto()};function ce(e){function t(t){var a,r,i=H(e);if(t&&(r={type:"listbox",label:"Image list",name:"image-list",values:c.buildListItems(t,function(t){t.value=e.convertURL(t.value||t.url,"src")},[{text:"None",value:""}]),value:i.src&&e.convertURL(i.src,"src"),onselect:function(e){var t=a.find("#alt");(!t.value()||e.lastControl&&t.value()===e.lastControl.text())&&t.value(e.control.text()),a.find("#src").value(e.control.value()).fire("change")},onPostRender:function(){r=this}}),n.hasAdvTab(e)||n.hasUploadUrl(e)||n.hasUploadHandler(e)){var o=[Y.makeTab(e,r)];n.hasAdvTab(e)&&o.push(G.makeTab(e)),(n.hasUploadUrl(e)||n.hasUploadHandler(e))&&o.push(le.makeTab(e)),a=e.windowManager.open({title:"Insert/edit image",data:i,bodyType:"tabpanel",body:o,onSubmit:ue(se,e)})}else a=e.windowManager.open({title:"Insert/edit image",data:i,body:Y.getGeneralItems(e,r),onSubmit:ue(se,e)});q.syncSize(a)}return{open:function(){c.createImageList(e,t)}}}var de=function(e){e.addCommand("mceImage",ce(e).open)},ge=function(e){var t=e.attr("class");return t&&/\bimage\b/.test(t)},me=function(e){return function(t){for(var n,a=t.length,r=function(t){t.attr("contenteditable",e?"true":null)};a--;)n=t[a],ge(n)&&(n.attr("contenteditable",e?"false":null),l.each(n.getAll("figcaption"),r))}},fe=function(e){e.on("preInit",function(){e.parser.addNodeFilter("figure",me(!0)),e.serializer.addNodeFilter("figure",me(!1))})},pe=function(e){e.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:ce(e).open,stateSelector:"img:not([data-mce-object],[data-mce-placeholder]),figure.image"}),e.addMenuItem("image",{icon:"image",text:"Image",onclick:ce(e).open,context:"insert",prependToContext:!0})};t.add("image",function(e){fe(e),pe(e),de(e)})}();